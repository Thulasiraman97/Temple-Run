<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Run 3D</title>
    <style>
        body,
        html {
            margin: 0;
            overflow: hidden;
            background-color: #0a2e0a;
            touch-action: none;
            /* Prevents browser swipe-navigation on tablets */
            user-select: none;
            /* Prevents text highlighting while tapping */
            -webkit-user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2560&auto=format&fit=crop') center/cover no-repeat;
        }

        .brand-logo {
            position: absolute;
            top: 20px;
            left: 20px;
            height: 80px;
            /* Adjust based on actual image size */
            z-index: 1000;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            display: none;
            /* Hidden by default until logged in */
        }

        .login-logo {
            display: block;
            margin: 0 auto 20px auto;
            height: 100px;
            /* Bigger logo for login */
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        #game-container {
            width: 100vw;
            height: 100vh;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 10;
        }

        .modal {
            background-color: rgba(10, 46, 10, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            animation: fadeIn 0.3s ease-out forwards;
        }

        .modal h2 {
            margin-top: 0;
            color: #ecf0f1;
            border-bottom: 2px solid rgba(46, 204, 113, 0.5);
            padding-bottom: 10px;
        }

        .answers button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(46, 204, 113, 0.5);
            background-color: rgba(20, 60, 20, 0.5);
            color: #ecf0f1;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .answers button:hover {
            background-color: rgba(46, 204, 113, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .hidden {
            display: none;
        }

        #result-modal ul {
            list-style-type: 'üëâ';
            padding-left: 20px;
        }

        #result-modal li {
            padding-left: 10px;
            margin-bottom: 10px;
        }

        #result-modal .selected {
            color: #2ecc71;
            font-weight: bold;
        }

        #result-modal .not-selected {
            color: #e74c3c;
            font-weight: bold;
        }

        .auth-input {
            width: 90%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid rgba(46, 204, 113, 0.5);
            background-color: rgba(20, 60, 20, 0.5);
            color: #ecf0f1;
            font-size: 16px;
        }

        .auth-input::placeholder {
            color: rgba(236, 240, 241, 0.6);
        }

        .auth-btn {
            background-color: rgba(46, 204, 113, 0.8);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .auth-btn:hover {
            background-color: rgba(46, 204, 113, 1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .auth-link {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            border-radius: 5px;
            width: 45px;
            height: 45px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }
    </style>
</head>

<body>
    <img src="logo.png" alt="WeLe Logo" class="brand-logo">
    <div id="game-container"></div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="overlay">
        <button class="fullscreen-btn" onclick="toggleFullScreen()" title="Toggle Fullscreen">‚õ∂</button>
        <div class="modal">
            <img src="logo.png" alt="WeLe Logo" class="login-logo">
            <h2 id="auth-title">üèÉRun Login</h2>

            <div id="login-section">
                <input type="text" id="login-mobile" placeholder="Enter 10-digit Mobile Number" maxlength="10"
                    pattern="\d{10}" title="Only 10 digit numbers allowed" class="auth-input"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                <button id="login-btn" class="auth-btn">Start Game</button>
                <p style="text-align:center; margin-top:15px;">New player? <a class="auth-link" id="show-signup">Sign up
                        here</a></p>
            </div>

            <div id="signup-section" class="hidden">
                <input type="text" id="signup-username" placeholder="Enter Username" maxlength="25"
                    pattern="[A-Za-z ]{1,25}" title="Only alphabets are allowed" class="auth-input"
                    oninput="this.value = this.value.replace(/[^A-Za-z ]/g, '')">
                <input type="text" id="signup-mobile" placeholder="Enter 10-digit Mobile Number" maxlength="10"
                    pattern="\d{10}" title="Only 10 digit numbers allowed" class="auth-input"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                <input type="email" id="signup-email" placeholder="Enter Email ID" class="auth-input">
                <button id="signup-btn" class="auth-btn">Create Profile</button>
                <p style="text-align:center; margin-top:15px;">Already have an account? <a class="auth-link"
                        id="show-login">Login here</a></p>
            </div>
            <p id="auth-error-msg" style="color:#e74c3c; text-align:center; font-weight:bold; margin-top:10px;"></p>
        </div>
    </div>

    <!-- Initial Instructions Modal -->
    <div id="start-modal" class="overlay hidden">
        <div class="modal">
            <h2>üèÉ Welcome to the Interview Run</h2>
            <p>You are about to enter a job interview simulation ‚Äî but with a twist!</p>
            <ul style="line-height:2; padding-left:20px;">
                <li>üöß <strong>Hit an Coin</strong> to unlock an interview question.</li>
                <li>‚¨ÖÔ∏è‚û°Ô∏è Use <strong>Arrow Keys</strong> or <strong>Swipe Left/Right</strong> to switch lanes.</li>
                <li>üí° <strong>Steer INTO</strong> Coin to score points (Max score: 10).</li>
                <li>‚õî <strong>Beware:</strong> Picking 3 negative answers ends the interview
                    <strong>immediately</strong>!
                </li>
                <li>üèÅ Cross all <strong>5 Coin</strong> to complete the interview.</li>
            </ul>
            <p style="color:#2ecc71; font-weight:bold;">Tip: You must HIT the Coin ‚Äî dodging it skips the question!
            </p>
            <div class="answers">
                <button id="start-button">Begin Interview</button>
            </div>
        </div>
    </div>

    <!-- Question Modal -->
    <div id="question-modal" class="overlay hidden">
        <div class="modal">
            <h2 id="question-text">Question placeholder</h2>
            <div id="answer-buttons" class="answers">
                <!-- Buttons will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="overlay hidden">
        <div class="modal">
            <h2 id="result-title">Evaluation Result</h2>
            <p id="result-status"></p>
            <p id="result-reason"></p>
            <h3>Areas for Improvement:</h3>
            <ul id="improvement-list"></ul>
            <div class="answers" style="margin-top: 20px;">
                <button id="restart-button" onclick="logoutGame()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        // --- GAME SETUP ---
        const fogColor = 0xb4e6d4; // Light morning mist to match forest
        const scene = new THREE.Scene();
        scene.background = null; // Transparent background to show CSS nature image
        scene.fog = new THREE.FogExp2(fogColor, 0.007); // Exp2 fog looks more natural
        const clock = new THREE.Clock();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setClearColor(0x000000, 0); // Ensure transparency
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // For softer shadows
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('game-container').appendChild(renderer.domElement);

        // --- TEXTURE LOADER ---
        const textureLoader = new THREE.TextureLoader();
        // Textures from Poly Haven (https://polyhaven.com/)
        const groundTexture = textureLoader.load('https://dl.polyhaven.org/file/ph-assets/Textures/jpg/1k/grass_path_3/grass_path_3_diff_1k.jpg');
        const obstacleTexture = textureLoader.load('https://dl.polyhaven.org/file/ph-assets/Textures/jpg/1k/metal_plate/metal_plate_diff_1k.jpg');
        // Player texture for fallback model
        const playerBodyTexture = textureLoader.load('https://dl.polyhaven.org/file/ph-assets/Textures/jpg/1k/fabric_pattern_07/fabric_pattern_07_diff_1k.jpg');

        // Allow cross-origin texture loading
        textureLoader.crossOrigin = 'anonymous';

        // Configure texture wrapping for repeating textures
        groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
        groundTexture.repeat.set(5, 250); // Repeat 5 times horizontally, 250 times vertically

        // No side walls in nature mode

        // --- UI ELEMENTS (move before model load to avoid race conditions) ---
        const startButton = document.getElementById('start-button');
        const startModal = document.getElementById('start-modal');
        const questionModal = document.getElementById('question-modal');
        const resultModal = document.getElementById('result-modal');
        const questionText = document.getElementById('question-text');
        const answerButtonsContainer = document.getElementById('answer-buttons');

        // Auth UI
        const authModal = document.getElementById('auth-modal');
        const loginSection = document.getElementById('login-section');
        const signupSection = document.getElementById('signup-section');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const authErrorMsg = document.getElementById('auth-error-msg');

        // --- KEYBOARD RESPONSIVENESS (ENTER TO SUBMIT) ---
        const handleEnterKey = (button) => (event) => {
            if (event.key === 'Enter') {
                button.click();
            }
        };

        const loginInputs = document.querySelectorAll('#login-section input');
        loginInputs.forEach(input => input.addEventListener('keypress', handleEnterKey(loginBtn)));

        const signupInputs = document.querySelectorAll('#signup-section input');
        signupInputs.forEach(input => input.addEventListener('keypress', handleEnterKey(signupBtn)));

        startButton.innerText = "Loading Model...";
        startButton.disabled = true;

        // --- GLOBAL VARIABLES ---
        let loggedInMobile = null; // Store user login info
        let gameState = 'paused'; // 'running', 'paused', 'question', 'finished'
        let score = 0;
        let negativeCount = 0;
        let currentQuestionIndex = 0;
        let selectedQuestions = []; // 5 randomly picked each game
        const apiUrl = '/api';

        // --- AUTH LOGIC ---
        showSignupBtn.onclick = () => {
            loginSection.classList.add('hidden');
            signupSection.classList.remove('hidden');
            authErrorMsg.innerText = '';
        };

        showLoginBtn.onclick = () => {
            signupSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            authErrorMsg.innerText = '';
        };

        loginBtn.onclick = async () => {
            const mobile = document.getElementById('login-mobile').value;
            const mobileRegex = /^\d{10}$/;

            if (!mobileRegex.test(mobile)) {
                authErrorMsg.innerText = 'Please enter a valid 10-digit mobile number containing only numbers.';
                return;
            }
            authErrorMsg.innerText = 'Logging in...';
            try {
                const res = await fetch(`${apiUrl}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mobile })
                });
                const data = await res.json();
                if (data.success) {
                    // Redirect to Admin if user is admin
                    if (data.user && data.user.isAdmin) {
                        window.location.href = '/admin.html';
                        return;
                    }
                    loggedInMobile = mobile;
                    authModal.classList.add('hidden');
                    document.querySelector('.brand-logo').style.display = 'block';

                    if (data.hasPlayed && data.pastResult) {
                        displayPastResult(data.pastResult);
                    } else {
                        startModal.classList.remove('hidden');
                    }
                } else {
                    authErrorMsg.innerText = data.error || 'Login failed.';
                }
            } catch (err) {
                authErrorMsg.innerText = 'Server error. Is the backend running?';
            }
        };

        signupBtn.onclick = async () => {
            const username = document.getElementById('signup-username').value;
            const mobile = document.getElementById('signup-mobile').value;
            const email = document.getElementById('signup-email').value;

            const nameRegex = /^[A-Za-z ]{1,25}$/;
            const mobileRegex = /^\d{10}$/;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!nameRegex.test(username)) {
                authErrorMsg.innerText = 'Username must contain only alphabets and be max 25 characters.';
                return;
            }
            if (!mobileRegex.test(mobile)) {
                authErrorMsg.innerText = 'Mobile must be exactly 10 digits.';
                return;
            }
            if (!emailRegex.test(email)) {
                authErrorMsg.innerText = 'Please enter a valid email address.';
                return;
            }

            authErrorMsg.innerText = 'Signing up...';
            try {
                const res = await fetch(`${apiUrl}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, mobile, email })
                });
                const data = await res.json();
                if (data.success) {
                    // Redirect to Admin if user is admin (unlikely on fresh signup without DB edit, but robust)
                    if (data.user && data.user.isAdmin) {
                        window.location.href = '/admin.html';
                        return;
                    }
                    loggedInMobile = mobile;
                    authModal.classList.add('hidden');
                    document.querySelector('.brand-logo').style.display = 'block';
                    startModal.classList.remove('hidden');
                } else {
                    authErrorMsg.innerText = data.error || 'Signup failed.';
                }
            } catch (err) {
                authErrorMsg.innerText = 'Server error. Is the backend running?';
            }
        };

        // --- FULL QUESTION BANK (20 questions) ---
        const allQuestions = [
            {
                question: "When preparing for an interview, what do you focus on first?",
                insight: "Strategic preparation vs general preparation",
                answers: [
                    { text: "A) Practice common interview questions.", points: 1 },
                    { text: "B) Go with confidence and answer spontaneously.", points: -1 },
                    { text: "C) Research company, role & align my strengths accordingly.", points: 2 },
                    { text: "D) Revise my academic subjects.", points: 0 }
                ]
            },
            {
                question: "If you are confused between two career paths, what do you do?",
                insight: "Career clarity",
                answers: [
                    { text: "A) Follow what most friends are choosing.", points: -1 },
                    { text: "B) Speak to mentors and professionals.", points: 1 },
                    { text: "C) Choose the one with higher salary.", points: 0 },
                    { text: "D) Analyze strengths, interests & long-term opportunities.", points: 2 }
                ]
            },
            {
                question: "How do you respond if you don‚Äôt know an answer in an interview?",
                insight: "Honesty and problem-solving",
                answers: [
                    { text: "A) Try to bluff confidently.", points: -1 },
                    { text: "B) Attempt logically based on related knowledge.", points: 1 },
                    { text: "C) Admit honestly & explain how I would solve it.", points: 2 },
                    { text: "D) Say ‚ÄúI‚Äôm not sure‚Äù and stop there.", points: 0 }
                ]
            },
            {
                question: "What makes a resume strong in 2026?",
                insight: "Impact vs format",
                answers: [
                    { text: "A) Fancy design with graphics.", points: -1 },
                    { text: "B) Real projects with measurable impact.", points: 2 },
                    { text: "C) Multiple pages listing everything done.", points: 0 },
                    { text: "D) Relevant certifications & updated skills.", points: 1 }
                ]
            },
            {
                question: "How do you prepare for AI-driven job changes?",
                insight: "Adaptability",
                answers: [
                    { text: "A) Assume AI won‚Äôt affect my field much.", points: 0 },
                    { text: "B) Actively learn and apply AI tools in my domain.", points: 2 },
                    { text: "C) Ignore AI because it feels complicated.", points: -1 },
                    { text: "D) Stay updated about industry trends.", points: 1 }
                ]
            },
            {
                question: "The interviewer asks: ‚ÄúWhy should we hire you?‚Äù",
                insight: "Value positioning",
                answers: [
                    { text: "A) Say I really need this job.", points: -1 },
                    { text: "B) Highlight my strengths confidently.", points: 1 },
                    { text: "C) Connect my skills to the company‚Äôs real needs.", points: 2 },
                    { text: "D) Say I‚Äôm hardworking and passionate.", points: 0 }
                ]
            },
            {
                question: "You receive critical feedback in a mock interview. What do you do?",
                insight: "Growth mindset",
                answers: [
                    { text: "A) Practice more on weak areas.", points: 1 },
                    { text: "B) Think the interviewer was too harsh.", points: -1 },
                    { text: "C) Reflect, improve & reattempt.", points: 2 },
                    { text: "D) Feel disappointed but move on.", points: 0 }
                ]
            },
            {
                question: "When given a task outside your comfort zone:",
                insight: "Learning readiness",
                answers: [
                    { text: "A) Try to avoid the task.", points: -1 },
                    { text: "B) Accept as learning opportunity & take action.", points: 2 },
                    { text: "C) Hesitate but complete it if required.", points: 0 },
                    { text: "D) Break into steps and attempt.", points: 1 }
                ]
            },
            {
                question: "What does career clarity mean to you?",
                insight: "Strategic alignment",
                answers: [
                    { text: "A) Taking whatever opportunity comes.", points: -1 },
                    { text: "B) Knowing which industry suits me.", points: 1 },
                    { text: "C) Having a job after graduation.", points: 0 },
                    { text: "D) Align strengths, interests & market demand strategically.", points: 2 }
                ]
            },
            {
                question: "In group discussions, how do you stand out?",
                insight: "Structured communication",
                answers: [
                    { text: "A) Speak at least once to be noticed.", points: 0 },
                    { text: "B) Stay silent to avoid mistakes.", points: -1 },
                    { text: "C) Present structured insights & summarize effectively.", points: 2 },
                    { text: "D) Share relevant points confidently.", points: 1 }
                ]
            },
            {
                question: "How do you show problem-solving ability?",
                insight: "Real-world application",
                answers: [
                    { text: "A) Give general answers without clarity.", points: -1 },
                    { text: "B) Share past experiences briefly.", points: 1 },
                    { text: "C) Explain structured thinking with real examples.", points: 2 },
                    { text: "D) Talk about theoretical knowledge.", points: 0 }
                ]
            },
            {
                question: "What matters more early in career?",
                insight: "Long-term growth",
                answers: [
                    { text: "A) Brand name only.", points: -1 },
                    { text: "B) Immediate high salary.", points: 0 },
                    { text: "C) Skill growth & long-term learning.", points: 2 },
                    { text: "D) Balanced role with fair pay.", points: 1 }
                ]
            },
            {
                question: "If your skills don‚Äôt match 100% of job description:",
                insight: "Proactive upskilling",
                answers: [
                    { text: "A) Apply highlighting transferable skills.", points: 1 },
                    { text: "B) Decide not to apply at all.", points: -1 },
                    { text: "C) Upskill immediately & build proof projects.", points: 2 },
                    { text: "D) Wait until fully qualified.", points: 0 }
                ]
            },
            {
                question: "When facing failure:",
                insight: "Resilience",
                answers: [
                    { text: "A) Avoid similar challenges in future.", points: -1 },
                    { text: "B) Try again with adjustments.", points: 1 },
                    { text: "C) Analyze mistakes & improve strategy.", points: 2 },
                    { text: "D) Feel discouraged for some time.", points: 0 }
                ]
            },
            {
                question: "How do you build interview confidence?",
                insight: "Simulation vs assumption",
                answers: [
                    { text: "A) Assume confidence will come naturally.", points: -1 },
                    { text: "B) Mock interviews under real conditions.", points: 2 },
                    { text: "C) Watch motivational videos.", points: 0 },
                    { text: "D) Prepare common answers.", points: 1 }
                ]
            },
            {
                question: "How do you stay competitive in job market?",
                insight: "Continuous learning",
                answers: [
                    { text: "A) Wait for campus placement only.", points: -1 },
                    { text: "B) Continuous upskilling + practical application.", points: 2 },
                    { text: "C) Rely on degree qualification.", points: 0 },
                    { text: "D) Networking & staying informed.", points: 1 }
                ]
            },
            {
                question: "What differentiates top candidates?",
                insight: "Practical application",
                answers: [
                    { text: "A) Confident body language alone.", points: -1 },
                    { text: "B) Ability to apply knowledge in real-world scenarios.", points: 2 },
                    { text: "C) High academic scores.", points: 0 },
                    { text: "D) Strong communication.", points: 1 }
                ]
            },
            {
                question: "If asked about strengths:",
                insight: "Evidence-based answers",
                answers: [
                    { text: "A) Struggle to define strengths clearly.", points: -1 },
                    { text: "B) Support answer with measurable achievements.", points: 2 },
                    { text: "C) State general qualities like hardworking.", points: 0 },
                    { text: "D) Mention relevant skills confidently.", points: 1 }
                ]
            },
            {
                question: "How do you handle pressure in interviews?",
                insight: "Composure",
                answers: [
                    { text: "A) Panic internally and lose clarity.", points: -1 },
                    { text: "B) Take a moment before answering.", points: 1 },
                    { text: "C) Speak quickly to finish.", points: 0 },
                    { text: "D) Stay calm & structure responses logically.", points: 2 }
                ]
            },
            {
                question: "In 2026, what truly gets you hired?",
                insight: "Skill and adaptability",
                answers: [
                    { text: "A) Degree qualification.", points: 0 },
                    { text: "B) Luck & connections only.", points: -1 },
                    { text: "C) Skill + adaptability + problem-solving ability.", points: 2 },
                    { text: "D) Strong communication & updated knowledge.", points: 1 }
                ]
            }
        ];

        // Pick 5 random questions from the bank
        function pickRandomQuestions() {
            const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, 5);
        }

        // --- 3D OBJECTS ---
        let playerModel, animationMixer;

        // Player state for lane movement
        const lanes = [-3, 0, 3];
        let currentLane = 1; // 0: left, 1: center, 2: right

        // --- MODEL LOADER ---
        const loader = new THREE.GLTFLoader();
        loader.load(
            // Reliable human character model from Three.js examples
            'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/models/gltf/Soldier.glb',
            function (gltf) {
                playerModel = gltf.scene;
                playerModel.scale.set(1.5, 1.5, 1.5); // Adjust scale for the new model
                playerModel.position.y = 0;
                playerModel.rotation.y = 0; // Face the character away from the camera
                playerModel.position.x = lanes[currentLane];

                playerModel.traverse(function (child) {
                    if (child.isMesh) {
                        child.castShadow = true;
                    }
                });

                scene.add(playerModel);

                // Animation
                animationMixer = new THREE.AnimationMixer(playerModel);
                // The Soldier model has an animation named 'Run'
                let runClip = THREE.AnimationClip.findByName(gltf.animations, 'Run');

                if (runClip) {
                    const runAction = animationMixer.clipAction(runClip);
                    runAction.play();
                } else {
                    console.warn("Could not find 'Run' animation in the model.");
                }

                // Enable start button
                startButton.innerText = "Begin Interview";
                startButton.disabled = false;
            },
            undefined, // onProgress callback
            function (error) {
                console.error('An error happened while loading the GLTF model:', error);
                // Show clearer UI message
                if (startButton) {
                    startButton.innerText = "Model Error (see console)";
                    startButton.disabled = true;
                }
                // Create a simple fallback player so the game can still run
                try {
                    const fallbackGeometry = new THREE.BoxGeometry(1, 2, 1);
                    const fallbackMaterial = new THREE.MeshStandardMaterial({ map: playerBodyTexture });
                    const fallbackPlayer = new THREE.Mesh(fallbackGeometry, fallbackMaterial);
                    fallbackPlayer.position.y = 1;
                    fallbackPlayer.position.x = lanes[currentLane];
                    fallbackPlayer.castShadow = true;
                    playerModel = fallbackPlayer;
                    scene.add(playerModel);
                    // enable start button so user can play with fallback
                    if (startButton) {
                        startButton.innerText = "Begin Interview";
                        startButton.disabled = false;
                    }
                } catch (e) {
                    console.error('Failed to create fallback player:', e);
                }
            }
        );

        // Ground
        const groundGeometry = new THREE.PlaneGeometry(20, 1000);
        const groundMaterial = new THREE.MeshStandardMaterial({ map: groundTexture, side: THREE.DoubleSide });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.receiveShadow = true;
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // Road markings for speed effect
        const markingMaterial = new THREE.MeshStandardMaterial({ color: 0xeeeeee });
        const markingGeometry = new THREE.BoxGeometry(0.5, 0.1, 7);
        const markingCount = 50;
        for (let i = 0; i < markingCount; i++) {
            const marking = new THREE.Mesh(markingGeometry, markingMaterial);
            marking.position.z = -i * 20;
            marking.position.y = 0.01; // Place it just above the ground plane
            scene.add(marking);
        }

        // Side walls removed for natural open environment

        // Obstacles (Coins)
        const obstacles = [];
        // A thin cylinder to represent a coin
        const obstacleGeometry = new THREE.CylinderGeometry(1, 1, 0.2, 32);
        const obstacleMaterial = new THREE.MeshStandardMaterial({
            color: 0xffd700, // Gold color
            emissive: 0xd4af37, // Golden glow to overpower green ambient lighting
            emissiveIntensity: 0.6,
            metalness: 0.5,  // Reduced so it doesn't just mirror the green lights
            roughness: 0.2   // Smoother for shiny look
        });
        for (let i = 0; i < 5; i++) {
            const obstacle = new THREE.Mesh(obstacleGeometry, obstacleMaterial.clone());
            obstacle.castShadow = true;
            obstacle.position.z = -30 * (i + 1) - 20; // Space them out more
            obstacle.position.y = 1;
            obstacle.rotation.x = Math.PI / 2; // Stand the coin on its edge
            // Place obstacle in a random lane
            obstacle.position.x = lanes[Math.floor(Math.random() * lanes.length)];
            obstacles.push(obstacle);
            scene.add(obstacle);
        }

        function logoutGame() {
            window.location.reload();
        }

        // Lighting ‚Äî warm green-tinted ambient + bright directional
        const ambientLight = new THREE.AmbientLight(0x88cc88, 0.7); // green-tinted ambient
        scene.add(ambientLight);

        // --- FULLSCREEN FUNCTION ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch((err) => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0); // pale green sunlight
        directionalLight.castShadow = true;

        // Define explicit shadow bounds so they stay crisp around the player
        directionalLight.shadow.camera.near = 0.5;
        directionalLight.shadow.camera.far = 50;
        directionalLight.shadow.camera.left = -15;
        directionalLight.shadow.camera.right = 15;
        directionalLight.shadow.camera.top = 15;
        directionalLight.shadow.camera.bottom = -15;
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);
        // Add target to scene so we can update it
        scene.add(directionalLight.target);

        // Extra fill light from below for richer green look
        const fillLight = new THREE.PointLight(0x33aa33, 0.4, 80);
        fillLight.position.set(0, 3, 0);
        scene.add(fillLight);

        // --- CAMERA ---
        camera.position.set(0, 5, 7); // Adjusted for better view
        camera.lookAt(new THREE.Vector3(0, 0, 0));

        // --- UI ELEMENTS ---
        // (startButton moved earlier to be available during model load)
        // Other UI elements already declared above

        // --- GAME LOGIC ---
        function showQuestion(index) {
            gameState = 'question';
            const q = selectedQuestions[index];
            // Show question number, question text and insight
            questionText.innerHTML = `<span style="font-size:13px;color:#aaa;">Question ${index + 1} of 5</span><br>${q.question}<br><span style="font-size:12px;color:#3498db;margin-top:6px;display:block;">üí° Insight: ${q.insight}</span>`;
            answerButtonsContainer.innerHTML = '';
            q.answers.forEach(answer => {
                const button = document.createElement('button');
                button.innerText = answer.text; // Score hidden from player
                button.onclick = () => handleAnswer(answer);
                answerButtonsContainer.appendChild(button);
            });
            questionModal.classList.remove('hidden');
        }

        function handleAnswer(answer) {
            score += answer.points; // Add +1 or +2 points
            if (answer.points < 0) {
                negativeCount++;
            }
            currentQuestionIndex++;
            questionModal.classList.add('hidden');

            if (negativeCount >= 3 || currentQuestionIndex >= selectedQuestions.length) {
                endGame();
            } else {
                gameState = 'running';
            }
        }

        function endGame() {
            gameState = 'finished';
            const resultTitle = document.getElementById('result-title');
            const resultStatus = document.getElementById('result-status');
            const resultReason = document.getElementById('result-reason');
            const improvementList = document.getElementById('improvement-list');

            // Score display (max 10)
            resultTitle.innerText = `üéØ Interview Result ‚Äî Score: ${score} / 10`;
            improvementList.innerHTML = '';

            if (score >= 8) {
                resultStatus.innerText = "üî•Career Strategist";
                resultStatus.className = "selected";
                resultReason.innerHTML = "<strong>üìä Interview Readiness Level:</strong><br>Highly job-ready mindset. You think strategically, adapt to AI trends, and understand value positioning.<br><br><strong>‚ùì Why You Still Might Miss Some Opportunities:</strong><br>- High competition at top level<br>- Need strong networking presence<br>- Requires consistent visibility & personal branding";

                const tips = [
                    "Build strong LinkedIn presence",
                    "Develop authority in one domain",
                    "Practice advanced mock interviews",
                    "Focus on execution consistency",
                    "You don‚Äôt chase jobs. You position yourself for them."
                ];
                tips.forEach(tip => {
                    const li = document.createElement('li');
                    li.innerHTML = tip;
                    improvementList.appendChild(li);
                });
            } else if (score >= 5) {
                resultStatus.innerText = "üü¢ Emerging Professional";
                resultStatus.className = "selected";
                resultReason.innerHTML = "<strong>üìä Interview Readiness Level:</strong><br>You are moderately job-ready. You think practically but still lack competitive edge.<br><br><strong>‚ùì Why You May Not Always Get Selected:</strong><br>- Good answers but not memorable<br>- Need stronger differentiation<br>- Limited real-world application examples<br>- Slight hesitation in pressure situations";
                const tips = [
                    "Add measurable impact to resume",
                    "Build 2‚Äì3 strong real-world projects",
                    "Improve structured communication",
                    "Sharpen confidence with mock simulations",
                    "You are close ‚Äî polish makes the difference."
                ];
                tips.forEach(tip => {
                    const li = document.createElement('li');
                    li.innerHTML = tip;
                    improvementList.appendChild(li);
                });
            } else if (score >= 1) {
                resultStatus.innerText = "üü° Basic Awareness Level";
                resultStatus.className = "not-selected";
                resultReason.innerHTML = "<strong>üìä Interview Readiness Level:</strong><br>You understand interviews at a surface level, but your preparation lacks depth and strategic clarity.<br><br><strong>‚ùì Why You Are Not Getting Selected:</strong><br>- Answers are generic, not impactful<br>- No measurable achievements shown<br>- Preparation is theoretical, not practical<br>- Confidence fluctuates under pressure";
                const tips = [
                    "Convert skills into proof-based examples",
                    "Practice mock interviews under real conditions",
                    "Learn how to position your value",
                    "Upgrade skills aligned with 2026 job market",
                    "You are trying ‚Äî but not strategically yet."
                ];
                tips.forEach(tip => {
                    const li = document.createElement('li');
                    li.innerHTML = tip;
                    improvementList.appendChild(li);
                });
            } else {
                resultStatus.innerText = "üî¥ Career Confusion Zone";
                resultStatus.className = "not-selected";
                resultReason.innerHTML = "<strong>üìä Interview Readiness Level:</strong><br>You are currently not ready for job interviews. Your mindset shows hesitation, reactive decisions, or lack of preparation depth.<br><br><strong>‚ùì Why You Are Not Getting Selected:</strong><br>- Decisions based on pressure, not clarity<br>- Avoiding challenges instead of solving them<br>- Depending only on degree or luck<br>- Low structured thinking in interviews";
                const tips = [
                    "Build self-awareness (Strength Identification)",
                    "Practice structured answering (STAR Method)",
                    "Develop problem-solving thinking",
                    "Start mock interviews immediately",
                    "Learn how job market actually works",
                    "You don‚Äôt lack potential. You lack direction."
                ];
                tips.forEach(tip => {
                    const li = document.createElement('li');
                    li.innerHTML = tip;
                    improvementList.appendChild(li);
                });
            }
            resultModal.classList.remove('hidden');

            // Send to backend if logged in
            if (loggedInMobile) {
                fetch(`${apiUrl}/game-result`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mobile: loggedInMobile,
                        score: score,
                        category: resultStatus.innerText
                    })
                }).catch(e => console.error('Failed to save result:', e));
            }
        }

        // Mirrors endGame visually, but uses past statistics and skips DB saving
        function displayPastResult(pastResult) {
            gameState = 'finished';
            const resultTitle = document.getElementById('result-title');
            const resultStatus = document.getElementById('result-status');
            const resultReason = document.getElementById('result-reason');
            const improvementList = document.getElementById('improvement-list');

            score = pastResult.score;
            resultTitle.innerText = `üéØ Interview Result ‚Äî Score: ${score} / 10`;
            improvementList.innerHTML = '';

            // Set the category explicitly from the saved one since it's known
            resultStatus.innerText = pastResult.category;
            resultStatus.className = (score >= 5) ? "selected" : "not-selected";

            // Re-populate reason and tips (could also save these to DB if they were dynamic, but here we can just map score)
            if (score >= 8) {
                resultReason.innerHTML = "<strong>üìä Interview Readiness Level:</strong><br>Highly job-ready mindset. You think strategically, adapt to AI trends, and understand value positioning.<br><br><strong>‚ùì Why You Still Might Miss Some Opportunities:</strong><br>- High competition at top level<br>- Need strong networking presence<br>- Requires consistent visibility & personal branding";
                const tips = [
                    "Build strong LinkedIn presence", "Develop authority in one domain", "Practice advanced mock interviews", "Focus on execution consistency", "You don‚Äôt chase jobs. You position yourself for them."
                ];
                tips.forEach(tip => { let li = document.createElement('li'); li.innerHTML = tip; improvementList.appendChild(li); });
            } else if (score >= 5) {
                resultReason.innerHTML = "<strong>üìä Interview Readiness Level:</strong><br>You are moderately job-ready. You think practically but still lack competitive edge.<br><br><strong>‚ùì Why You May Not Always Get Selected:</strong><br>- Good answers but not memorable<br>- Need stronger differentiation<br>- Limited real-world application examples<br>- Slight hesitation in pressure situations";
                const tips = [
                    "Add measurable impact to resume", "Build 2‚Äì3 strong real-world projects", "Improve structured communication", "Sharpen confidence with mock simulations", "You are close ‚Äî polish makes the difference."
                ];
                tips.forEach(tip => { let li = document.createElement('li'); li.innerHTML = tip; improvementList.appendChild(li); });
            } else if (score >= 1) {
                resultReason.innerHTML = "<strong>üìä Interview Readiness Level:</strong><br>You understand interviews at a surface level, but your preparation lacks depth and strategic clarity.<br><br><strong>‚ùì Why You Are Not Getting Selected:</strong><br>- Answers are generic, not impactful<br>- No measurable achievements shown<br>- Preparation is theoretical, not practical<br>- Confidence fluctuates under pressure";
                const tips = [
                    "Convert skills into proof-based examples", "Practice mock interviews under real conditions", "Learn how to position your value", "Upgrade skills aligned with 2026 job market", "You are trying ‚Äî but not strategically yet."
                ];
                tips.forEach(tip => { let li = document.createElement('li'); li.innerHTML = tip; improvementList.appendChild(li); });
            } else {
                resultReason.innerHTML = "<strong>üìä Interview Readiness Level:</strong><br>You are currently not ready for job interviews. Your mindset shows hesitation, reactive decisions, or lack of preparation depth.<br><br><strong>‚ùì Why You Are Not Getting Selected:</strong><br>- Decisions based on pressure, not clarity<br>- Avoiding challenges instead of solving them<br>- Depending only on degree or luck<br>- Low structured thinking in interviews";
                const tips = [
                    "Build self-awareness (Strength Identification)", "Practice structured answering (STAR Method)", "Develop problem-solving thinking", "Start mock interviews immediately", "Learn how job market actually works", "You don‚Äôt lack potential. You lack direction."
                ];
                tips.forEach(tip => { let li = document.createElement('li'); li.innerHTML = tip; improvementList.appendChild(li); });
            }

            resultModal.classList.remove('hidden');
        }

        function restartGame() {
            // Hide result modal
            resultModal.classList.add('hidden');

            // Reset state
            score = 0;
            negativeCount = 0;
            currentQuestionIndex = 0;
            selectedQuestions = pickRandomQuestions();

            // Reset player and camera position
            if (playerModel) {
                playerModel.position.z = 0;
                playerModel.position.x = lanes[1]; // center lane
                currentLane = 1;
            }
            camera.position.z = 7;
            camera.position.x = 0;

            // Reposition obstacles and reset visibility
            obstacles.forEach((obstacle, i) => {
                obstacle.position.z = -30 * (i + 1) - 20;
                obstacle.position.x = lanes[Math.floor(Math.random() * lanes.length)];
                obstacle.material.color.setHex(0xffd700); // Reset to gold coin color
                obstacle.visible = true; // Make the coin visible again
            });

            gameState = 'running';
        }

        // --- ANIMATION LOOP ---
        function animate() {
            const delta = clock.getDelta(); // Time since last frame for smooth animation
            const time = clock.getElapsedTime(); // Useful for bobbing animation
            const runSpeed = 20; // Game speed in units per second

            if (animationMixer) {
                animationMixer.update(delta);
            }

            // Animate coins (spinning and bobbing)
            obstacles.forEach((obstacle, index) => {
                obstacle.rotation.z += 3 * delta; // Spin
                obstacle.position.y = 1.2 + Math.sin(time * 3 + index) * 0.3; // Bob up and down
            });

            if (gameState === 'running' && playerModel) {
                // Move player forward
                playerModel.position.z -= runSpeed * delta;
                // Camera follows player
                camera.position.z -= runSpeed * delta;

                // --- Follow logic for Lights ---
                directionalLight.position.z = camera.position.z + 0.5;
                directionalLight.position.x = camera.position.x + 5;
                directionalLight.target.position.set(playerModel.position.x, playerModel.position.y, playerModel.position.z);
                fillLight.position.z = camera.position.z - 7;
                fillLight.position.x = camera.position.x;

                // Smoothly move player between lanes
                const targetX = lanes[currentLane];
                playerModel.position.x = THREE.MathUtils.lerp(playerModel.position.x, targetX, 0.1);

                // Make camera smoothly follow player's horizontal movement
                camera.position.x = THREE.MathUtils.lerp(camera.position.x, playerModel.position.x, 0.05);
                // Look at a point around the character's chest height
                camera.lookAt(playerModel.position.x, playerModel.position.y + 1.2, playerModel.position.z);

                // Collision check: trigger question only when player hits the obstacle
                // (same lane in X AND within Z range) ‚Äî dodge = no question
                if (obstacles[currentQuestionIndex]) {
                    const obstacle = obstacles[currentQuestionIndex];
                    const zDist = Math.abs(playerModel.position.z - obstacle.position.z);
                    const xDist = Math.abs(playerModel.position.x - obstacle.position.x);
                    if (zDist < 2.5 && xDist < 1.5) {
                        // Make the coin disappear upon collision
                        if (obstacle.visible) {
                            obstacle.visible = false;
                            showQuestion(currentQuestionIndex);
                        }
                    } else if (playerModel.position.z < obstacle.position.z - 3) {
                        // Player dodged this obstacle ‚Äî advance to next
                        currentQuestionIndex++;
                        if (currentQuestionIndex >= selectedQuestions.length) {
                            endGame();
                        }
                    }
                }
            }
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }

        // --- EVENT LISTENERS ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        document.addEventListener('keydown', (event) => {
            if (gameState !== 'running') return;

            if (event.key === 'ArrowLeft' || event.key === 'a') {
                if (currentLane > 0) currentLane--;
            } else if (event.key === 'ArrowRight' || event.key === 'd') {
                if (currentLane < lanes.length - 1) currentLane++;
            }
        });

        // --- TOUCH SWIPE CONTROLS FOR TABLETS/MOBILES ---
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            if (gameState !== 'running') return;
            const swipeThreshold = 50; // Minimum distance to register as a swipe
            if (touchEndX < touchStartX - swipeThreshold) {
                // Swiped left
                if (currentLane > 0) currentLane--;
            } else if (touchEndX > touchStartX + swipeThreshold) {
                // Swiped right
                if (currentLane < lanes.length - 1) currentLane++;
            }
        }

        startButton.addEventListener('click', () => {
            selectedQuestions = pickRandomQuestions(); // Pick 5 random questions each game
            score = 0;
            negativeCount = 0;
            currentQuestionIndex = 0;
            startModal.classList.add('hidden');
            gameState = 'running';
        });

        // --- START ---
        animate();
    </script>
</body>

</html>